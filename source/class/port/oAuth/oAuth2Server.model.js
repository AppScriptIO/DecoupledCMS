"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.default = void 0;var _ApplicationClass = _interopRequireDefault(require("../../Application.class.js"));
var _rethinkdb = _interopRequireDefault(require("rethinkdb"));
var _getTableDocumentAndFilterQuery = _interopRequireDefault(require("@dependency/databaseUtility/source/getTableDocumentAndFilter.query.js"));

let getTableDocument = {
  generate: _getTableDocumentAndFilterQuery.default,
  instance: [] };

getTableDocument.instance['oAuth_token'] = getTableDocument.generate('oAuth_token');
getTableDocument.instance['oAuth_client'] = getTableDocument.generate('oAuth_client');
getTableDocument.instance['oAuth_user'] = getTableDocument.generate('oAuth_user');var _default =

{





  generateAccessToken: undefined,
  generateRefreshToken: undefined,
  generateAuthorizationCode: undefined,
  getUserFromClient: undefined,


















  getUser: async (userId, userPassword) => {
    console.log('getUser function');
    const connection = _ApplicationClass.default.rethinkdbConnection;
    let dbFilterObject = { key: userId, password: userPassword };
    let user = await getTableDocument.instance['oAuth_user'](connection, dbFilterObject);

    return {
      username: user.key,
      password: user.password };

  },












  getClient: async (clientId, clientSecret) => {
    console.log('getClient function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let dbFilterObject = clientSecret ? { key: clientId, clientSecret: clientSecret } : { key: clientId };
    let client = await getTableDocument.instance['oAuth_client'](connection, dbFilterObject);
    if (!client) return null;

    return {
      id: client.key,
      redirectUris: [client.redirectUri],
      grants: client.grantType };




  },












  getAccessToken: async accessToken => {
    console.log('getAccessToken function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let tokenData = await getTableDocument.instance['oAuth_token'](connection, { type: 'accessToken', token: accessToken });
    if (!tokenData) return null;
    let client = await getTableDocument.instance['oAuth_client'](connection, { key: tokenData.clientId });
    let user = await getTableDocument.instance['oAuth_user'](connection, { key: tokenData.userId });

    return {
      accessToken: tokenData.token,
      accessTokenExpiresAt: tokenData.expiresAt,
      scope: tokenData.scope,
      client: Object.assign(client, { id: client.key }),
      user: {
        username: user.key } };


  },














  getRefreshToken: async refreshToken => {
    console.log('getRefreshToken function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let tokenData = await getTableDocument.instance['oAuth_token'](connection, { type: 'refreshToken', token: refreshToken });
    if (!tokenData) return null;
    let client = await getTableDocument.instance['oAuth_client'](connection, { key: tokenData.clientId });
    let user = await getTableDocument.instance['oAuth_user'](connection, { key: tokenData.userId });

    return {
      refreshToken: tokenData.token,
      refreshTokenExpiresAt: tokenData.expiresAt,
      scope: tokenData.scope,
      client: Object.assign(client, { id: client.key }),
      user: {
        username: user.key } };


  },














  getAuthorizationCode: async authorizationCode => {
    console.log('getAuthorizationCode function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let tokenData = await getTableDocument.instance['oAuth_token'](connection, { type: 'authorizationCode', token: authorizationCode });
    if (!tokenData) return null;
    let client = await getTableDocument.instance['oAuth_client'](connection, { key: tokenData.clientId });
    let user = await getTableDocument.instance['oAuth_user'](connection, { key: tokenData.userId });

    return {
      code: tokenData.token,
      expiresAt: tokenData.expiresAt,
      redirectUri: tokenData.redirectUri,
      scope: tokenData.scope,
      client: Object.assign(client, { id: client.key }),
      user: {
        username: user.key } };


  },














  saveToken: async (token, client, user) => {
    console.log('saveToken function');
    let userId = user.username;


    const connection = _ApplicationClass.default.rethinkdbConnection;
    let returnedValue = {
      scope: token.scope,
      client: client,
      user: user };


    if (token.accessToken) {
      await _rethinkdb.default.
      db('webappSetting').
      table('oAuth_token').
      insert({
        token: token.accessToken,
        expiresAt: token.accessTokenExpiresAt,
        scope: token.scope,
        clientId: client.id,
        type: 'accessToken',
        userId: userId }).

      run(connection);
    }

    if (token.refreshToken) {
      await _rethinkdb.default.
      db('webappSetting').
      table('oAuth_token').
      insert({
        token: token.refreshToken,
        expiresAt: token.refreshTokenExpiresAt,
        scope: token.scope,
        clientId: client.id,
        userId: userId,
        type: 'refreshToken' }).

      run(connection);
    }

    Object.assign(returnedValue, {

      refreshToken: token.refreshToken,
      refreshTokenExpiresAt: token.refreshTokenExpiresAt,
      accessToken: token.accessToken,
      accessTokenExpiresAt: token.accessTokenExpiresAt });


    return returnedValue;
  },














  saveAuthorizationCode: async (code, client, user) => {
    console.log('saveAuthorizationCode function');

    let userId = user.username;
    const connection = _ApplicationClass.default.rethinkdbConnection;

    await _rethinkdb.default.
    db('webappSetting').
    table('oAuth_token').
    insert({
      type: 'authorizationCode',
      token: code.authorizationCode,
      expiresAt: code.expiresAt,
      redirectUri: code.redirectUri,
      scope: code.scope,
      clientId: client.id,
      userId: userId }).

    run(connection);

    return {
      authorizationCode: code.authorizationCode,
      expiresAt: code.expiresAt,
      redirectUri: code.redirectUri,
      scope: code.scope,
      client: client,
      user: user };

  },















  revokeToken: async token => {
    console.log('revokeToken function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let filterObject = { token: token.refreshToken };
    let { deleted: deletionResult } = await _rethinkdb.default.
    db('webappSetting').
    table('oAuth_token').
    filter(filterObject).
    delete().
    run(connection);
    return deletionResult ? true : false;
  },














  revokeAuthorizationCode: async code => {
    console.log('revokeAuthorizationCode function');

    const connection = _ApplicationClass.default.rethinkdbConnection;
    let filterObject = { token: code.code };
    let { deleted: deletionResult } = await _rethinkdb.default.
    db('webappSetting').
    table('oAuth_token').
    filter(filterObject).
    delete().
    run(connection);
    return deletionResult ? true : false;
  },












  validateScope: async (user, client, scope) => {
    console.log('validateScope function');
    if (!scope) return null;
    const connection = _ApplicationClass.default.rethinkdbConnection;
    let dbFilterObject = { key: client.id };
    client = await getTableDocument.instance['oAuth_client'](connection, dbFilterObject);
    if (!client || !client.scope) return null;
    let validScopes = client.scope.split(',').map(s => s.trim());
    let scopes = scope.
    split(',').
    map(s => s.trim()).
    filter(s => validScopes.indexOf(s) >= 0);
    return scope.length ? scopes.join(',') : null;
  },














  verifyScope: async (accessToken, scope) => {
    console.log('verifyScope function');


    if (!scope) return true;
    if (!accessToken.scope) return false;
    validScopes = scope.split(',').map(s => s.trim());
    scopes = accessToken.scope.split(',').map(s => s.trim());

    return scopes.some(s => validScopes.indexOf(s) >= 0);
  } };exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NvdXJjZS9jbGFzcy9wb3J0L29BdXRoL29BdXRoMlNlcnZlci5tb2RlbC5qcyJdLCJuYW1lcyI6WyJnZXRUYWJsZURvY3VtZW50IiwiZ2VuZXJhdGUiLCJnZXRUYWJsZURvY3VtZW50QW5kRmlsdGVyIiwiaW5zdGFuY2UiLCJnZW5lcmF0ZUFjY2Vzc1Rva2VuIiwidW5kZWZpbmVkIiwiZ2VuZXJhdGVSZWZyZXNoVG9rZW4iLCJnZW5lcmF0ZUF1dGhvcml6YXRpb25Db2RlIiwiZ2V0VXNlckZyb21DbGllbnQiLCJnZXRVc2VyIiwidXNlcklkIiwidXNlclBhc3N3b3JkIiwiY29uc29sZSIsImxvZyIsImNvbm5lY3Rpb24iLCJBcHBsaWNhdGlvbiIsInJldGhpbmtkYkNvbm5lY3Rpb24iLCJkYkZpbHRlck9iamVjdCIsImtleSIsInBhc3N3b3JkIiwidXNlciIsInVzZXJuYW1lIiwiZ2V0Q2xpZW50IiwiY2xpZW50SWQiLCJjbGllbnRTZWNyZXQiLCJjbGllbnQiLCJpZCIsInJlZGlyZWN0VXJpcyIsInJlZGlyZWN0VXJpIiwiZ3JhbnRzIiwiZ3JhbnRUeXBlIiwiZ2V0QWNjZXNzVG9rZW4iLCJhY2Nlc3NUb2tlbiIsInRva2VuRGF0YSIsInR5cGUiLCJ0b2tlbiIsImFjY2Vzc1Rva2VuRXhwaXJlc0F0IiwiZXhwaXJlc0F0Iiwic2NvcGUiLCJPYmplY3QiLCJhc3NpZ24iLCJnZXRSZWZyZXNoVG9rZW4iLCJyZWZyZXNoVG9rZW4iLCJyZWZyZXNoVG9rZW5FeHBpcmVzQXQiLCJnZXRBdXRob3JpemF0aW9uQ29kZSIsImF1dGhvcml6YXRpb25Db2RlIiwiY29kZSIsInNhdmVUb2tlbiIsInJldHVybmVkVmFsdWUiLCJyZXRoaW5rREIiLCJkYiIsInRhYmxlIiwiaW5zZXJ0IiwicnVuIiwic2F2ZUF1dGhvcml6YXRpb25Db2RlIiwicmV2b2tlVG9rZW4iLCJmaWx0ZXJPYmplY3QiLCJkZWxldGVkIiwiZGVsZXRpb25SZXN1bHQiLCJmaWx0ZXIiLCJkZWxldGUiLCJyZXZva2VBdXRob3JpemF0aW9uQ29kZSIsInZhbGlkYXRlU2NvcGUiLCJ2YWxpZFNjb3BlcyIsInNwbGl0IiwibWFwIiwicyIsInRyaW0iLCJzY29wZXMiLCJpbmRleE9mIiwibGVuZ3RoIiwiam9pbiIsInZlcmlmeVNjb3BlIiwic29tZSJdLCJtYXBwaW5ncyI6InlMQUFBO0FBQ0E7QUFDQTs7QUFFQSxJQUFJQSxnQkFBZ0IsR0FBRztBQUNyQkMsRUFBQUEsUUFBUSxFQUFFQyx1Q0FEVztBQUVyQkMsRUFBQUEsUUFBUSxFQUFFLEVBRlcsRUFBdkI7O0FBSUFILGdCQUFnQixDQUFDRyxRQUFqQixDQUEwQixhQUExQixJQUEyQ0gsZ0JBQWdCLENBQUNDLFFBQWpCLENBQTBCLGFBQTFCLENBQTNDO0FBQ0FELGdCQUFnQixDQUFDRyxRQUFqQixDQUEwQixjQUExQixJQUE0Q0gsZ0JBQWdCLENBQUNDLFFBQWpCLENBQTBCLGNBQTFCLENBQTVDO0FBQ0FELGdCQUFnQixDQUFDRyxRQUFqQixDQUEwQixZQUExQixJQUEwQ0gsZ0JBQWdCLENBQUNDLFFBQWpCLENBQTBCLFlBQTFCLENBQTFDLEM7O0FBRWU7Ozs7OztBQU1iRyxFQUFBQSxtQkFBbUIsRUFBRUMsU0FOUjtBQU9iQyxFQUFBQSxvQkFBb0IsRUFBRUQsU0FQVDtBQVFiRSxFQUFBQSx5QkFBeUIsRUFBRUYsU0FSZDtBQVNiRyxFQUFBQSxpQkFBaUIsRUFBRUgsU0FUTjs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTRCYkksRUFBQUEsT0FBTyxFQUFFLE9BQU9DLE1BQVAsRUFBZUMsWUFBZixLQUFnQztBQUN2Q0MsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksa0JBQVo7QUFDQSxVQUFNQyxVQUFVLEdBQUdDLDBCQUFZQyxtQkFBL0I7QUFDQSxRQUFJQyxjQUFjLEdBQUcsRUFBRUMsR0FBRyxFQUFFUixNQUFQLEVBQWVTLFFBQVEsRUFBRVIsWUFBekIsRUFBckI7QUFDQSxRQUFJUyxJQUFJLEdBQUcsTUFBTXBCLGdCQUFnQixD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Q0FBZixHQUFrQyxJQUF6QztBQUNELEdBbldZOzs7Ozs7Ozs7Ozs7Ozs7QUFrWGJDLEVBQUFBLFdBQVcsRUFBRSxPQUFPeEMsV0FBUCxFQUFvQk0sS0FBcEIsS0FBOEI7QUFDekMxQixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxzQkFBWjs7O0FBR0EsUUFBSSxDQUFDeUIsS0FBTCxFQUFZLE9BQU8sSUFBUDtBQUNaLFFBQUksQ0FBQ04sV0FBVyxDQUFDTSxLQUFqQixFQUF3QixPQUFPLEtBQVA7QUFDeEJ5QixJQUFBQSxXQUFXLEdBQUd6QixLQUFLLENBQUMwQixLQUFOLENBQVksR0FBWixFQUFpQkMsR0FBakIsQ0FBcUJDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxJQUFGLEVBQTFCLENBQWQ7QUFDQUMsSUFBQUEsTUFBTSxHQUFHcEMsV0FBVyxDQUFDTSxLQUFaLENBQWtCMEIsS0FBbEIsQ0FBd0IsR0FBeEIsRUFBNkJDLEdBQTdCLENBQWlDQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsSUFBRixFQUF0QyxDQUFUOztBQUVBLFdBQU9DLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZUCxDQUFDLElBQUlILFdBQVcsQ0FBQ00sT0FBWixDQUFvQkgsQ0FBcEIsS0FBMEIsQ0FBM0MsQ0FBUDtBQUNELEdBNVhZLEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZWZhdWx0IGFzIEFwcGxpY2F0aW9uIH0gZnJvbSAnLi4vLi4vQXBwbGljYXRpb24uY2xhc3MuanMnXG5pbXBvcnQgcmV0aGlua0RCIGZyb20gJ3JldGhpbmtkYidcbmltcG9ydCBnZXRUYWJsZURvY3VtZW50QW5kRmlsdGVyIGZyb20gJ0BkZXBlbmRlbmN5L2RhdGFiYXNlVXRpbGl0eS9zb3VyY2UvZ2V0VGFibGVEb2N1bWVudEFuZEZpbHRlci5xdWVyeS5qcydcblxubGV0IGdldFRhYmxlRG9jdW1lbnQgPSB7XG4gIGdlbmVyYXRlOiBnZXRUYWJsZURvY3VtZW50QW5kRmlsdGVyLFxuICBpbnN0YW5jZTogW10sXG59XG5nZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF90b2tlbiddID0gZ2V0VGFibGVEb2N1bWVudC5nZW5lcmF0ZSgnb0F1dGhfdG9rZW4nKVxuZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfY2xpZW50J10gPSBnZXRUYWJsZURvY3VtZW50LmdlbmVyYXRlKCdvQXV0aF9jbGllbnQnKVxuZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfdXNlciddID0gZ2V0VGFibGVEb2N1bWVudC5nZW5lcmF0ZSgnb0F1dGhfdXNlcicpXG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgLy8gTW9kZWwgZnVuY3Rpb25zIHJlcXVpcmVkIGJ5IG5vZGUtYXV0aDItc2VydmVyIFNlZSBodHRwczovL2dpdGh1Yi5jb20vb2F1dGhqcy9ub2RlLW9hdXRoMi1zZXJ2ZXIgZm9yIHNwZWNpZmljYXRpb25cblxuICAvKipcbiAgICogTm90IGltcGxlbWVudGVkLCB1c2luZyBkZWZhdWx0IGluc3RlYWQuXG4gICAqL1xuICBnZW5lcmF0ZUFjY2Vzc1Rva2VuOiB1bmRlZmluZWQsXG4gIGdlbmVyYXRlUmVmcmVzaFRva2VuOiB1bmRlZmluZWQsXG4gIGdlbmVyYXRlQXV0aG9yaXphdGlvbkNvZGU6IHVuZGVmaW5lZCxcbiAgZ2V0VXNlckZyb21DbGllbnQ6IHVuZGVmaW5lZCxcblxuICAvLyAvKipcbiAgLy8gICogSW52b2tlZCB0byBnZW5lcmF0ZSBhIG5ldyBhY2Nlc3MgdG9rZW4uXG4gIC8vICAqIEBwYXJhbSB7b2JqZWN0fSBjbGllbnQgVGhlIGNsaWVudCB0aGUgYWNjZXNzIHRva2VuIGlzIGdlbmVyYXRlZCBmb3IuXG4gIC8vICAqIEBwYXJhbSB7b2JqZWN0fSB1c2VyIFRoZSB1c2VyIHRoZSBhY2Nlc3MgdG9rZW4gaXMgZ2VuZXJhdGVkIGZvci5cbiAgLy8gICogQHBhcmFtIHtzdHJpbmd9IHNjb3BlIFRoZSBzY29wZXMgYXNzb2NpYXRlZCB3aXRoIHRoZSBhY2Nlc3MgdG9rZW4uIGNhbiBiZSBudWxsLlxuICAvLyAgKiBAcmV0dXJuIHtzdHJpbmd9IGFjY2Vzc1Rva2VuIC0gQSBTdHJpbmcgdG8gYmUgdXNlZCBhcyBhY2Nlc3MgdG9rZW4uXG4gIC8vICAqL1xuICAvLyBnZW5lcmF0ZUFjY2Vzc1Rva2VuOiBhc3luYyAoY2xpZW50LCB1c2VyLCBzY29wZSkgPT4ge1xuXG4gIC8vIH0sXG5cbiAgLyoqXG4gICAqIEludm9rZWQgdG8gcmV0cmlldmUgYSB1c2VyIHVzaW5nIGEgdXNlcm5hbWUvcGFzc3dvcmQgY29tYmluYXRpb24uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJQYXNzd29yZFxuICAgKiBAcmV0dXJuIHtvYmplY3R9IHJlcHJlc2VudGluZyB0aGUgdXNlciBvciBmYWxzeSBpZiBubyBzdWNoIHVzZXIgY291bGQgYmUgZm91bmQuXG4gICAqL1xuICBnZXRVc2VyOiBhc3luYyAodXNlcklkLCB1c2VyUGFzc3dvcmQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnZ2V0VXNlciBmdW5jdGlvbicpXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IEFwcGxpY2F0aW9uLnJldGhpbmtkYkNvbm5lY3Rpb25cbiAgICBsZXQgZGJGaWx0ZXJPYmplY3QgPSB7IGtleTogdXNlcklkLCBwYXNzd29yZDogdXNlclBhc3N3b3JkIH1cbiAgICBsZXQgdXNlciA9IGF3YWl0IGdldFRhYmxlRG9jdW1lbnQuaW5zdGFuY2VbJ29BdXRoX3VzZXInXShjb25uZWN0aW9uLCBkYkZpbHRlck9iamVjdClcblxuICAgIHJldHVybiB7XG4gICAgICB1c2VybmFtZTogdXNlci5rZXksXG4gICAgICBwYXNzd29yZDogdXNlci5wYXNzd29yZCxcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIHRoZSBub2RlLW9hdXRoMi1zZXJ2ZXIgdXNlIHRoaXMgbWV0aG9kIHRvIGdldCBkZXRhaWwgaW5mb21hdGlvbiBvZiBhIHJlZ2lzdGVyZWQgY2xpZW50LlxuICAgKiBAcGFyYW0ge1N0cmluZ30gY2xpZW50SWQgLSB0aGUgY2xpZW50IGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbY2xpZW50U2VjcmV0XSAtIHRoZSBjbGllbnQgc2VjcmV0LCB1c2VkIGluIHRoZSB0b2tlbiBncmFudGluZyBwaGFzZSB0byBhdXRoZW50aWNhdGUgdGhlIG9hdXRoIGNsaWVudFxuICAgKiBAcmV0dXJuIHtPYmplY3R9IGNsaWVudCAtIHRoZSBjbGllbnQgb2JqZWN0LCBjb250YWluaW5nIChhdCBsZWFzdCkgdGhlIGZvbGxvd2luZyBpbmZvbWF0aW9uLCBvciBudWxsIGlmIHRoZSBjbGllbnQgaXMgbm90IGEgdmFsaWQgcmVnaXN0ZXJlZCBjbGllbnQgb3IgdGhlIGNsaWVudCBzZWNyZXQgZG9lc24ndCBtYXRjaCB0aGUgY2xpZW50SWQ6XG4gICAqICAgICAgICAge1N0cmluZ30gY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiAgICAgICAgIHtBcnJheTxTdHJpbmc+fSBncmFudHMgLSBhbiBhcnJheSBvZiBncmFudCB0eXBlcyBhbGxvd2VkIGZvciB0aGlzIGNsaWVudCwgYWxsb3dlZCB2YWx1ZXMgYXJlOiBhdXRob3JpemF0aW9uX2NvZGUgfCBjbGllbnRfY3JlZGVudGlhbHMgfCBwYXNzd29yZCB8IHJlZnJlc2hfdG9rZW5cbiAgICogICAgICAgICB7QXJyYXk8U3RyaW5nPn0gcmVkaXJlY3RVcmlzIC0gYW4gYXJyYXkgb2YgdXJscyAob2YgdGhlIGNsaWVudCkgdGhhdCBhbGxvd2VkIGZvciByZWRpcmVjdGluZyB0byBieSB0aGUgb2F1dGggc2VydmVyXG4gICAqICAgICAgICAge051bWJlcn0gW2FjY2Vzc1Rva2VuTGlmZXRpbWU9MzYwMF0gLSBkZWZpbmUgdGhlIGxpZmV0aW1lIG9mIGFuIGFjY2VzcyB0b2tlbiBpbiBzZWNvbmRzLCBkZWZhdWx0IGlzIDEgaG91clxuICAgKiAgICAgICAgIHtOdW1iZXJ9IFtyZWZyZXNoVG9rZW5MaWZldGltZT0zNjAwICogMjQgKiAxNF0gLSBkZWZpbmUgdGhlIGxpZmV0aW1lIG9mIGFuIHJlZnJlc2ggdG9rZW4gaW4gc2Vjb25kcywgZGVmYXVsdCBpcyAyIHdlZWtzXG4gICAqL1xuICBnZXRDbGllbnQ6IGFzeW5jIChjbGllbnRJZCwgY2xpZW50U2VjcmV0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2dldENsaWVudCBmdW5jdGlvbicpXG5cbiAgICBjb25zdCBjb25uZWN0aW9uID0gQXBwbGljYXRpb24ucmV0aGlua2RiQ29ubmVjdGlvblxuICAgIGxldCBkYkZpbHRlck9iamVjdCA9IGNsaWVudFNlY3JldCA/IHsga2V5OiBjbGllbnRJZCwgY2xpZW50U2VjcmV0OiBjbGllbnRTZWNyZXQgfSA6IHsga2V5OiBjbGllbnRJZCB9XG4gICAgbGV0IGNsaWVudCA9IGF3YWl0IGdldFRhYmxlRG9jdW1lbnQuaW5zdGFuY2VbJ29BdXRoX2NsaWVudCddKGNvbm5lY3Rpb24sIGRiRmlsdGVyT2JqZWN0KVxuICAgIGlmICghY2xpZW50KSByZXR1cm4gbnVsbFxuICAgIC8vIHJldHVybiBpbiByZXF1aXJlZCBmb3JtYXQuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiBjbGllbnQua2V5LFxuICAgICAgcmVkaXJlY3RVcmlzOiBbY2xpZW50LnJlZGlyZWN0VXJpXSxcbiAgICAgIGdyYW50czogY2xpZW50LmdyYW50VHlwZSxcbiAgICAgIC8vIENsaWVudC1zcGVjaWZpYyBsaWZldGltZSBvZiBnZW5lcmF0ZWQgcmVmcmVzaCB0b2tlbnMgaW4gc2Vjb25kcy5cbiAgICAgIC8vIGFjY2Vzc1Rva2VuTGlmZXRpbWU6IGNsaWVudC5hY2Nlc3NUb2tlbkxpZmV0aW1lLFxuICAgICAgLy8gcmVmcmVzaFRva2VuTGlmZXRpbWU6IGNsaWVudC5yZWZyZXNoVG9rZW5MaWZldGltZVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogSW52b2tlZCB0byByZXRyaWV2ZSBhbiBleGlzdGluZyBhY2Nlc3MgdG9rZW4gcHJldmlvdXNseSBzYXZlZCB0aHJvdWdoIE1vZGVsI3NhdmVUb2tlbigpLlxuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjZXNzVG9rZW4gLSBUaGUgYWNjZXNzIHRva2VuIHRvIHJldHJpZXZlLlxuICAgKiBAcmV0dXJuIHtPYmplY3R9IHRva2VuIC0gQW4gT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWNjZXNzIHRva2VuIGFuZCBhc3NvY2lhdGVkIGRhdGEuIENvbnRhaW5pbmcgYXQgbGVhc3QgdGhlIGZvbGxvd2luZyBpbmZvcm1hdGlvbjpcbiAgICogICAgICAgICB7U3RyaW5nfSAuYWNjZXNzVG9rZW4gLSB0aGUgYWNjZXNzIHRva2VuIHN0cmluZ1xuICAgKiAgICAgICAgIHtEYXRlfSAgIC5hY2Nlc3NUb2tlbkV4cGlyZXNBdCAtIHRoZSBleGFjdCB0aW1lIHdoZW4gdGhlIGFjY2VzcyB0b2tlbiBzaG91bGQgZXhwaXJlXG4gICAqICAgICAgICAge1N0cmluZ30gLnNjb3BlIC0gYWNjZXNzIHNjb3BlIG9mIHRoaXMgYWNjZXNzIHRva2VuXG4gICAqICAgICAgICAge09iamVjdH0gLmNsaWVudCAtIHRoZSBvYXV0aCBjbGllbnRcbiAgICogICAgICAgICB7U3RyaW5nfSAuY2xpZW50LmlkIC0gc3RyaW5nIGlkIG9mIHRoZSBvYXV0aCBjbGllbnRcbiAgICogICAgICAgICB7T2JqZWN0fSAudXNlciAtIHRoZSB1c2VyIHdoaWNoIHRoaXMgYWNjZXNzIHRva2VuIHJlcHJlc2VudHMsIHRoaXMgZGF0YSBzdHJ1Y3R1cmUgb2YgdGhlIHVzZXIgb2JqZWN0IGlzIG5vdCBwYXJ0IG9mIHRoZSBNb2RlbCBTcGVjaWZpY2F0aW9uLCBhbmQgd2hhdCBpdCBzaG91bGQgYmUgaXMgY29tcGxldGVseSB1cCB0byB5b3UuIEluIHRoaXMgZXhhbXBsZSwgd2UgdXNlIHsgdXNlcm5hbWU6ICdzb21lVXNlck5hbWUnIH0gd2hlcmUgdGhlICd1c2VybmFtZScgZmllbGQgaXMgdXNlZCB0byB1bmlxdWVseSBpZGVudGlmeSBhbiB1c2VyIGluIHRoZSB1c2VyIGRhdGFiYXNlLlxuICAgKi9cbiAgZ2V0QWNjZXNzVG9rZW46IGFzeW5jIGFjY2Vzc1Rva2VuID0+IHtcbiAgICBjb25zb2xlLmxvZygnZ2V0QWNjZXNzVG9rZW4gZnVuY3Rpb24nKVxuXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IEFwcGxpY2F0aW9uLnJldGhpbmtkYkNvbm5lY3Rpb25cbiAgICBsZXQgdG9rZW5EYXRhID0gYXdhaXQgZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfdG9rZW4nXShjb25uZWN0aW9uLCB7IHR5cGU6ICdhY2Nlc3NUb2tlbicsIHRva2VuOiBhY2Nlc3NUb2tlbiB9KVxuICAgIGlmICghdG9rZW5EYXRhKSByZXR1cm4gbnVsbFxuICAgIGxldCBjbGllbnQgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF9jbGllbnQnXShjb25uZWN0aW9uLCB7IGtleTogdG9rZW5EYXRhLmNsaWVudElkIH0pXG4gICAgbGV0IHVzZXIgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF91c2VyJ10oY29ubmVjdGlvbiwgeyBrZXk6IHRva2VuRGF0YS51c2VySWQgfSlcbiAgICAvLyByZXR1cm4gaW4gcmVxdWlyZWQgZm9ybWF0LlxuICAgIHJldHVybiB7XG4gICAgICBhY2Nlc3NUb2tlbjogdG9rZW5EYXRhLnRva2VuLFxuICAgICAgYWNjZXNzVG9rZW5FeHBpcmVzQXQ6IHRva2VuRGF0YS5leHBpcmVzQXQsXG4gICAgICBzY29wZTogdG9rZW5EYXRhLnNjb3BlLFxuICAgICAgY2xpZW50OiBPYmplY3QuYXNzaWduKGNsaWVudCwgeyBpZDogY2xpZW50LmtleSB9KSwgLy8gd2l0aCAnaWQnIHByb3BlcnR5XG4gICAgICB1c2VyOiB7XG4gICAgICAgIHVzZXJuYW1lOiB1c2VyLmtleSxcbiAgICAgIH0sXG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiB0aGUgbm9kZS1vYXV0aDItc2VydmVyIHVzZSB0aGlzIG1ldGhvZCB0byBnZXQgZGV0YWlsIGluZm9ybWF0aW9uIG9mIGEgcmVmcmVzaCB0b2tlbiBwcmV2aW91c2x5IHN0b3JlZCB1c2VkIE9hdXRoTW9kZWwucHJvdG90eXBlLnNhdmVUb2tlbi5cbiAgICogPGI+Tm90ZTo8L2I+cmVmcmVzaCB0b2tlbiBpcyB1c2VkIGJ5IHRoZSBvYXV0aCBjbGllbnQgdG8gcmVxdWVzdCBmb3IgYSBuZXcgYWNjZXNzIHRva2VuLCBhbmQgaXQncyBhY3R1YWxseSBub3QgcmVsYXRlZCB0byBhbnkgYWNjZXNzIHRva2VuIGluIGFueSB3YXksIHNvIGFjY2VzcyB0b2tlbnMgYW5kIHJlZnJlc2ggdG9rZW5zIHNob3VsZCBiZSBzdG9yZWQgYW5kIHJldHJpZXZlZCBpbmRlcGVuZGVudCB0byBlYWNoIG90aGVyLlxuICAgKiBAcGFyYW0ge1N0cmluZ30gcmVmcmVzaFRva2VuIC0gdGhlIHJlZnJlc2ggdG9rZW4gc3RyaW5nXG4gICAqIEByZXR1cm4ge09iamVjdH0gdG9rZW4gLSB0aGUgdG9rZW4gb2JqZWN0IGNvbnRhaW5pbmcgKGF0IGxlYXN0KSB0aGUgZm9sbG93aW5nIGluZm9tYXRpb24sIG9yIG51bGwgaWYgdGhlIHJlZnJlc2ggdG9rZW4gZG9lc24ndCBleGlzdDpcbiAgICogICAgICAgIHtTdHJpbmd9IHRva2VuLnJlZnJlc2hUb2tlbiAtIHRoZSByZWZyZXNoIHRva2VuIHN0cmluZ1xuICAgKiAgICAgICAge0RhdGV9IHRva2VuLnJlZnJlc2hUb2tlbkV4cGlyZXNBdCAtIHRoZSBleGFjdCB0aW1lIHdoZW4gdGhlIHJlZnJlc2ggdG9rZW4gc2hvdWxkIGV4cGlyZVxuICAgKiAgICAgICAge1N0cmluZ30gc2NvcGUgLSB0aGUgYWNjZXNzIHNjb3BlXG4gICAqICAgICAgICB7T2JqZWN0fSBjbGllbnQgLSB0aGUgY2xpZW50IG9iamVjdFxuICAgKiAgICAgICAge1N0cmluZ30gY2xpZW50LmlkIC0gdGhlIGlkIG9mIHRoZSBjbGllbnRcbiAgICogICAgICAgIHtPYmplY3R9IHVzZXIgLSB0aGUgdXNlciBvYmplY3RcbiAgICogICAgICAgIHtTdHJpbmd9IHVzZXIudXNlcm5hbWUgLSBpZGVudGlmaWVyIG9mIHRoZSB1c2VyXG4gICAqL1xuICBnZXRSZWZyZXNoVG9rZW46IGFzeW5jIHJlZnJlc2hUb2tlbiA9PiB7XG4gICAgY29uc29sZS5sb2coJ2dldFJlZnJlc2hUb2tlbiBmdW5jdGlvbicpXG5cbiAgICBjb25zdCBjb25uZWN0aW9uID0gQXBwbGljYXRpb24ucmV0aGlua2RiQ29ubmVjdGlvblxuICAgIGxldCB0b2tlbkRhdGEgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF90b2tlbiddKGNvbm5lY3Rpb24sIHsgdHlwZTogJ3JlZnJlc2hUb2tlbicsIHRva2VuOiByZWZyZXNoVG9rZW4gfSlcbiAgICBpZiAoIXRva2VuRGF0YSkgcmV0dXJuIG51bGxcbiAgICBsZXQgY2xpZW50ID0gYXdhaXQgZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfY2xpZW50J10oY29ubmVjdGlvbiwgeyBrZXk6IHRva2VuRGF0YS5jbGllbnRJZCB9KVxuICAgIGxldCB1c2VyID0gYXdhaXQgZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfdXNlciddKGNvbm5lY3Rpb24sIHsga2V5OiB0b2tlbkRhdGEudXNlcklkIH0pXG4gICAgLy8gcmV0dXJuIGluIHJlcXVpcmVkIGZvcm1hdC5cbiAgICByZXR1cm4ge1xuICAgICAgcmVmcmVzaFRva2VuOiB0b2tlbkRhdGEudG9rZW4sXG4gICAgICByZWZyZXNoVG9rZW5FeHBpcmVzQXQ6IHRva2VuRGF0YS5leHBpcmVzQXQsXG4gICAgICBzY29wZTogdG9rZW5EYXRhLnNjb3BlLFxuICAgICAgY2xpZW50OiBPYmplY3QuYXNzaWduKGNsaWVudCwgeyBpZDogY2xpZW50LmtleSB9KSwgLy8gd2l0aCAnaWQnIHByb3BlcnR5XG4gICAgICB1c2VyOiB7XG4gICAgICAgIHVzZXJuYW1lOiB1c2VyLmtleSxcbiAgICAgIH0sIC8vIHdpdGggJ3VzZXJuYW1lJyBwcm9wZXJ0eVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogdGhlIG5vZGUtb2F1dGgyLXNlcnZlciB1c2UgdGhpcyBtZXRob2QgdG8gZ2V0IGRldGFpbCBpbmZvcm1hdGlvbiBvZiBhIGF1dGhvcml6YXRpb24gY29kZSBwcmV2aW91c2x5IHN0b3JlZCB1c2VkIE9hdXRoTW9kZWwucHJvdG90eXBlLnNhdmVBdXRob3JpemF0aW9uQ29kZS5cbiAgICogQHBhcmFtIHtTdHJpbmd9IGF1dGhvcml6YXRpb25Db2RlIC0gdGhlIGF1dGhvcml6YXRpb24gY29kZSBzdHJpbmdcbiAgICogQHJldHVybiB7T2JqZWN0fSBjb2RlIC0gdGhlIGNvZGUgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpbmZvcm1hdGlvbiwgb3IgbnVsbCBpZiB0aGUgYXV0aG9yaXphdGlvbiBjb2RlIGRvZXNuJ3QgZXhpc3RcbiAgICogICAgICAgICB7U3RyaW5nfSBjb2RlIC0gdGhlIGF1dGhvcml6YXRpb24gY29kZSBzdHJpbmdcbiAgICogICAgICAgICB7RGF0ZX0gZXhwaXJlc0F0IC0gdGhlIGV4YWN0IHRpbWUgd2hlbiB0aGUgY29kZSBzaG91bGQgZXhwaXJlXG4gICAqICAgICAgICAge1N0cmluZ30gcmVkaXJlY3RVcmkgLSB0aGUgcmVkaXJlY3RfdXJpIHF1ZXJ5IHBhcmFtZXRlciBvZiB0aGUgJy9vYXV0aC9hdXRob3JpemUnIHJlcXVlc3QsIGluZGljYXRpbmcgd2hlcmUgdG8gcmVkaXJlY3QgdG8gd2l0aCB0aGUgY29kZVxuICAgKiAgICAgICAgIHtTdHJpbmd9IHNjb3BlIC0gdGhlIGF1dGhvcml6YXRpb24gc2NvcGUgZGVjaWRpbmcgdGhlIGFjY2VzcyBzY29wZSBvZiB0aGUgYWNjZXNzIHRva2VuIHJlcXVlc3RlZCBieSB0aGUgb2F1dGggY2xpZW50IHVzaW5nIHRoaXMgY29kZVxuICAgKiAgICAgICAgIHtPYmplY3R9IGNsaWVudCAtIHRoZSBjbGllbnQgb2JqZWN0XG4gICAqICAgICAgICAge1N0cmluZ30gY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiAgICAgICAgIHtPYmplY3R9IHVzZXIgLSB0aGUgdXNlciBvYmplY3RcbiAgICogICAgICAgICB7U3RyaW5nfSB1c2VyLnVzZXJuYW1lIC0gdGhlIHVzZXIgaWRlbnRpZmllclxuICAgKi9cbiAgZ2V0QXV0aG9yaXphdGlvbkNvZGU6IGFzeW5jIGF1dGhvcml6YXRpb25Db2RlID0+IHtcbiAgICBjb25zb2xlLmxvZygnZ2V0QXV0aG9yaXphdGlvbkNvZGUgZnVuY3Rpb24nKVxuXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IEFwcGxpY2F0aW9uLnJldGhpbmtkYkNvbm5lY3Rpb25cbiAgICBsZXQgdG9rZW5EYXRhID0gYXdhaXQgZ2V0VGFibGVEb2N1bWVudC5pbnN0YW5jZVsnb0F1dGhfdG9rZW4nXShjb25uZWN0aW9uLCB7IHR5cGU6ICdhdXRob3JpemF0aW9uQ29kZScsIHRva2VuOiBhdXRob3JpemF0aW9uQ29kZSB9KVxuICAgIGlmICghdG9rZW5EYXRhKSByZXR1cm4gbnVsbFxuICAgIGxldCBjbGllbnQgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF9jbGllbnQnXShjb25uZWN0aW9uLCB7IGtleTogdG9rZW5EYXRhLmNsaWVudElkIH0pXG4gICAgbGV0IHVzZXIgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF91c2VyJ10oY29ubmVjdGlvbiwgeyBrZXk6IHRva2VuRGF0YS51c2VySWQgfSlcbiAgICAvLyByZXR1cm4gaW4gcmVxdWlyZWQgZm9ybWF0LlxuICAgIHJldHVybiB7XG4gICAgICBjb2RlOiB0b2tlbkRhdGEudG9rZW4sXG4gICAgICBleHBpcmVzQXQ6IHRva2VuRGF0YS5leHBpcmVzQXQsXG4gICAgICByZWRpcmVjdFVyaTogdG9rZW5EYXRhLnJlZGlyZWN0VXJpLFxuICAgICAgc2NvcGU6IHRva2VuRGF0YS5zY29wZSxcbiAgICAgIGNsaWVudDogT2JqZWN0LmFzc2lnbihjbGllbnQsIHsgaWQ6IGNsaWVudC5rZXkgfSksIC8vIHdpdGggJ2lkJyBwcm9wZXJ0eVxuICAgICAgdXNlcjoge1xuICAgICAgICB1c2VybmFtZTogdXNlci5rZXksXG4gICAgICB9LFxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogdGhlIG5vZGUtb2F1dGgyLXNlcnZlciB1c2VzIHRoaXMgbWV0aG9kIHRvIHNhdmUgYW4gYWNjZXNzIHRva2VuIGFuZCBhbiByZWZyZXNoIHRva2VuKGlmIHJlZnJlc2ggdG9rZW4gZW5hYmxlZCkgZHVyaW5nIHRoZSB0b2tlbiBncmFudGluZyBwaGFzZS5cbiAgICogQHBhcmFtIHtPYmplY3R9IHRva2VuIC0gdGhlIHRva2VuIG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4uYWNjZXNzVG9rZW4gLSB0aGUgYWNjZXNzIHRva2VuIHN0cmluZ1xuICAgKiBAcGFyYW0ge0RhdGV9IHRva2VuLmFjY2Vzc1Rva2VuRXhwaXJlc0F0IC0gQHNlZSBPYXV0aE1vZGVsLnByb3RvdHlwZS5nZXRBY2Nlc3NUb2tlblxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4ucmVmcmVzaFRva2VuIC0gdGhlIHJlZnJlc2ggdG9rZW4gc3RyaW5nXG4gICAqIEBwYXJhbSB7RGF0ZX0gdG9rZW4ucmVmcmVzaFRva2VuRXhwaXJlc0F0IC0gQHNlZSBPYXV0aE1vZGVsLnByb3RvdHlwZS5nZXRSZWZyZXNoVG9rZW5cbiAgICogQHBhcmFtIHtTdHJpbmd9IHRva2VuLnNjb3BlIC0gdGhlIGFjY2VzcyBzY29wZVxuICAgKiBAcGFyYW0ge09iamVjdH0gY2xpZW50IC0gdGhlIGNsaWVudCBvYmplY3QgLSBAc2VlIE9hdXRoTW9kZWwucHJvdG90eXBlLmdldENsaWVudFxuICAgKiAgICAgICAge1N0cmluZ30gY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiBAcGFyYW0ge09iamVjdH0gdXNlciAtIHRoZSB1c2VyIG9iamVjdCBAc2VlIE9hdXRoTW9kZWwucHJvdG90eXBlLmdldEFjY2Vzc1Rva2VuXG4gICAqIEByZXR1cm4ge09iamVjdH0gdG9rZW4gLSB0aGUgdG9rZW4gb2JqZWN0IHNhdmVkLCBzYW1lIGFzIHRoZSBwYXJhbWV0ZXIgJ3Rva2VuJ1xuICAgKi9cbiAgc2F2ZVRva2VuOiBhc3luYyAodG9rZW4sIGNsaWVudCwgdXNlcikgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdzYXZlVG9rZW4gZnVuY3Rpb24nKVxuICAgIGxldCB1c2VySWQgPSB1c2VyLnVzZXJuYW1lXG5cbiAgICAvLyBUT0RPOiBzZXQgZXhwaXJhdGlvbiAvIFRUTCAtIGh0dHBzOi8vZ3JvdXBzLmdvb2dsZS5jb20vZm9ydW0vIyF0b3BpYy9yZXRoaW5rZGIvdEZTaUc1RXgxS0UgZm9yIHJldGhpbmtkYiB1bmRlcmRldmVsb3BtZW50LlxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBBcHBsaWNhdGlvbi5yZXRoaW5rZGJDb25uZWN0aW9uXG4gICAgbGV0IHJldHVybmVkVmFsdWUgPSB7XG4gICAgICBzY29wZTogdG9rZW4uc2NvcGUsXG4gICAgICBjbGllbnQ6IGNsaWVudCxcbiAgICAgIHVzZXI6IHVzZXIsXG4gICAgfVxuXG4gICAgaWYgKHRva2VuLmFjY2Vzc1Rva2VuKSB7XG4gICAgICBhd2FpdCByZXRoaW5rREJcbiAgICAgICAgLmRiKCd3ZWJhcHBTZXR0aW5nJylcbiAgICAgICAgLnRhYmxlKCdvQXV0aF90b2tlbicpXG4gICAgICAgIC5pbnNlcnQoe1xuICAgICAgICAgIHRva2VuOiB0b2tlbi5hY2Nlc3NUb2tlbixcbiAgICAgICAgICBleHBpcmVzQXQ6IHRva2VuLmFjY2Vzc1Rva2VuRXhwaXJlc0F0LFxuICAgICAgICAgIHNjb3BlOiB0b2tlbi5zY29wZSxcbiAgICAgICAgICBjbGllbnRJZDogY2xpZW50LmlkLFxuICAgICAgICAgIHR5cGU6ICdhY2Nlc3NUb2tlbicsXG4gICAgICAgICAgdXNlcklkOiB1c2VySWQsXG4gICAgICAgIH0pXG4gICAgICAgIC5ydW4oY29ubmVjdGlvbilcbiAgICB9XG5cbiAgICBpZiAodG9rZW4ucmVmcmVzaFRva2VuKSB7XG4gICAgICBhd2FpdCByZXRoaW5rREJcbiAgICAgICAgLmRiKCd3ZWJhcHBTZXR0aW5nJylcbiAgICAgICAgLnRhYmxlKCdvQXV0aF90b2tlbicpXG4gICAgICAgIC5pbnNlcnQoe1xuICAgICAgICAgIHRva2VuOiB0b2tlbi5yZWZyZXNoVG9rZW4sXG4gICAgICAgICAgZXhwaXJlc0F0OiB0b2tlbi5yZWZyZXNoVG9rZW5FeHBpcmVzQXQsXG4gICAgICAgICAgc2NvcGU6IHRva2VuLnNjb3BlLFxuICAgICAgICAgIGNsaWVudElkOiBjbGllbnQuaWQsXG4gICAgICAgICAgdXNlcklkOiB1c2VySWQsXG4gICAgICAgICAgdHlwZTogJ3JlZnJlc2hUb2tlbicsXG4gICAgICAgIH0pXG4gICAgICAgIC5ydW4oY29ubmVjdGlvbilcbiAgICB9XG5cbiAgICBPYmplY3QuYXNzaWduKHJldHVybmVkVmFsdWUsIHtcbiAgICAgIC8vIHRva2VuIHRvIHRoZSByZXR1cm5lZCBvYmplY3QuXG4gICAgICByZWZyZXNoVG9rZW46IHRva2VuLnJlZnJlc2hUb2tlbixcbiAgICAgIHJlZnJlc2hUb2tlbkV4cGlyZXNBdDogdG9rZW4ucmVmcmVzaFRva2VuRXhwaXJlc0F0LFxuICAgICAgYWNjZXNzVG9rZW46IHRva2VuLmFjY2Vzc1Rva2VuLFxuICAgICAgYWNjZXNzVG9rZW5FeHBpcmVzQXQ6IHRva2VuLmFjY2Vzc1Rva2VuRXhwaXJlc0F0LFxuICAgIH0pXG5cbiAgICByZXR1cm4gcmV0dXJuZWRWYWx1ZVxuICB9LFxuXG4gIC8qKlxuICAgKiB0aGUgbm9kZS1vYXV0aDItc2VydmVyIHVzZXMgdGhpcyBtZXRob2QgdG8gc2F2ZSBhbiBhdXRob3JpemF0aW9uIGNvZGUuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjb2RlIC0gdGhlIGF1dGhvcml6YXRpb24gY29kZSBvYmplY3RcbiAgICogQHBhcmFtIHtTdHJpbmd9IGNvZGUuYXV0aG9yaXphdGlvbkNvZGUgLSB0aGUgYXV0aG9yaXphdGlvbiBjb2RlIHN0cmluZ1xuICAgKiBAcGFyYW0ge0RhdGV9IGNvZGUuZXhwaXJlc0F0IC0gdGhlIHRpbWUgd2hlbiB0aGUgY29kZSBzaG91bGQgZXhwaXJlXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBjb2RlLnJlZGlyZWN0VXJpIC0gd2hlcmUgdG8gcmVkaXJlY3QgdG8gd2l0aCB0aGUgY29kZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gW2NvZGUuc2NvcGVdIC0gdGhlIGF1dGhvcml6ZWQgYWNjZXNzIHNjb3BlXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjbGllbnQgLSB0aGUgY2xpZW50IG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiBAcGFyYW0ge09iamVjdH0gdXNlciAtIHRoZSB1c2VyIG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdXNlci51c2VybmFtZSAtIHRoZSB1c2VyIGlkZW50aWZpZXJcbiAgICogQHJldHVybiB7T2JqZWN0fSBjb2RlIC0gdGhlIGNvZGUgb2JqZWN0IHNhdmVkXG4gICAqL1xuICBzYXZlQXV0aG9yaXphdGlvbkNvZGU6IGFzeW5jIChjb2RlLCBjbGllbnQsIHVzZXIpID0+IHtcbiAgICBjb25zb2xlLmxvZygnc2F2ZUF1dGhvcml6YXRpb25Db2RlIGZ1bmN0aW9uJylcblxuICAgIGxldCB1c2VySWQgPSB1c2VyLnVzZXJuYW1lXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IEFwcGxpY2F0aW9uLnJldGhpbmtkYkNvbm5lY3Rpb25cblxuICAgIGF3YWl0IHJldGhpbmtEQlxuICAgICAgLmRiKCd3ZWJhcHBTZXR0aW5nJylcbiAgICAgIC50YWJsZSgnb0F1dGhfdG9rZW4nKVxuICAgICAgLmluc2VydCh7XG4gICAgICAgIHR5cGU6ICdhdXRob3JpemF0aW9uQ29kZScsXG4gICAgICAgIHRva2VuOiBjb2RlLmF1dGhvcml6YXRpb25Db2RlLFxuICAgICAgICBleHBpcmVzQXQ6IGNvZGUuZXhwaXJlc0F0LFxuICAgICAgICByZWRpcmVjdFVyaTogY29kZS5yZWRpcmVjdFVyaSxcbiAgICAgICAgc2NvcGU6IGNvZGUuc2NvcGUsXG4gICAgICAgIGNsaWVudElkOiBjbGllbnQuaWQsXG4gICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgfSlcbiAgICAgIC5ydW4oY29ubmVjdGlvbilcblxuICAgIHJldHVybiB7XG4gICAgICBhdXRob3JpemF0aW9uQ29kZTogY29kZS5hdXRob3JpemF0aW9uQ29kZSxcbiAgICAgIGV4cGlyZXNBdDogY29kZS5leHBpcmVzQXQsXG4gICAgICByZWRpcmVjdFVyaTogY29kZS5yZWRpcmVjdFVyaSxcbiAgICAgIHNjb3BlOiBjb2RlLnNjb3BlLFxuICAgICAgY2xpZW50OiBjbGllbnQsXG4gICAgICB1c2VyOiB1c2VyLFxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogdGhlIG5vZGUtb2F1dGgyLXNlcnZlciB1c2VzIHRoaXMgbWV0aG9kIHRvIHJldm9rZSBhIHJlZnJlc2ggdG9rZW4ocmVtb3ZlIGl0IGZyb20gdGhlIHN0b3JlKS5cbiAgICogTm90ZTogYnkgZGVmYXVsdCwgdGhlIG5vZGUtb2F1dGgyLXNlcnZlciBlbmFibGUgdGhlIG9wdGlvbiAnYWx3YXlzSXNzdWVOZXdSZWZyZXNoVG9rZW4nLCBtZWFuaW5nIHRoYXQgZXZlcnkgdGltZSB5b3UgdXNlIGEgcmVmcmVzaCB0b2tlbiB0byBnZXQgYSBuZXcgYWNjZXNzIHRva2VuLCB0aGUgcmVmcmVzaCB0b2tlbiBpdHNlbGYgd2lsbCBiZSByZXZva2VkIGFuZCBhIG5ldyBvbmUgd2lsbCBiZSBpc3N1ZWQgYWxvbmcgd2l0aCB0aGUgYWNjZXNzIHRva2VuICh5b3UgY2FuIHNldCB0aGUgb3B0aW9uIHRocm91Z2ggT0F1dGgyU2VydmVyLnRva2VuKHJlcXVlc3QsIHJlc3BvbnNlLCBbb3B0aW9uc10sIFtjYWxsYmFja10pIG9yIEtvYU9BdXRoU2VydmVyLnRva2VuKG9wdGlvbnMpKS5cbiAgICogSWYgeW91IGFsd2F5cyB1c2UgdGhlIHJlZnJlc2ggdG9rZW4gYmVmb3JlIGl0IGV4cGlyZXMsIHRoZW4gdGhlcmUgd2lsbCBhbHdheXMgYmUgYSB2YWxpZCByZWZyZXNoIHRva2VuIGluIHRoZSBzdG9yZSh1bmxlc3MgeW91IGV4cGxpY3RseSByZXZva2UgaXQpLiBUaGlzIG1ha2VzIGl0IHNlZW0gbGlrZSByZWZyZXNoIHRva2VuIG5ldmVyIGV4cGlyZXMuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB0b2tlbiAtIHRoZSB0b2tlbiBvYmplY3RcbiAgICogQHBhcmFtIHtTdHJpbmd9IHRva2VuLnJlZnJlc2hUb2tlbiAtIHRoZSByZWZyZXNoIHRva2VuIHN0cmluZ1xuICAgKiBAcGFyYW0ge0RhdGV9IHRva2VuLnJlZnJlc2hUb2tlbkV4cGlyZXNBdCAtIHRoZSBleGFjdCB0aW1lIHdoZW4gdGhlIHJlZnJlc2ggdG9rZW4gc2hvdWxkIGV4cGlyZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4uc2NvcGUgLSB0aGUgYWNjZXNzIHNjb3BlXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB0b2tlbi5jbGllbnQgLSB0aGUgY2xpZW50IG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4uY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiBAcGFyYW0ge09iamVjdH0gdG9rZW4udXNlciAtIHRoZSB1c2VyIG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4udXNlci51c2VybmFtZSAtIHRoZSB1c2VyIGlkZW50aWZpZXJcbiAgICogQHJldHVybiB7Qm9vbGVhbn0gLSB0cnVlIGlmIHRoZSB0b2tlbiB3YXMgc3VjY2Vzc2Z1bGx5IHJldm9rZWQsIGZhbHNlIGlmIHRoZSB0b2tlbiBjb3VuZCBub3QgYmUgZm91bmRcbiAgICovXG4gIHJldm9rZVRva2VuOiBhc3luYyB0b2tlbiA9PiB7XG4gICAgY29uc29sZS5sb2coJ3Jldm9rZVRva2VuIGZ1bmN0aW9uJylcblxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBBcHBsaWNhdGlvbi5yZXRoaW5rZGJDb25uZWN0aW9uXG4gICAgbGV0IGZpbHRlck9iamVjdCA9IHsgdG9rZW46IHRva2VuLnJlZnJlc2hUb2tlbiB9XG4gICAgbGV0IHsgZGVsZXRlZDogZGVsZXRpb25SZXN1bHQgfSA9IGF3YWl0IHJldGhpbmtEQlxuICAgICAgLmRiKCd3ZWJhcHBTZXR0aW5nJylcbiAgICAgIC50YWJsZSgnb0F1dGhfdG9rZW4nKVxuICAgICAgLmZpbHRlcihmaWx0ZXJPYmplY3QpXG4gICAgICAuZGVsZXRlKClcbiAgICAgIC5ydW4oY29ubmVjdGlvbilcbiAgICByZXR1cm4gZGVsZXRpb25SZXN1bHQgPyB0cnVlIDogZmFsc2VcbiAgfSxcblxuICAvKipcbiAgICogdGhlIG5vZGUtb2F1dGgyLXNlcnZlciB1c2VzIHRoaXMgbWV0aG9kIHRvIHJldm9rZSBhIGF1dGhvcml6YXRpb24gY29kZShtb3N0bHkgd2hlbiBpdCBleHBpcmVzKVxuICAgKiBAcGFyYW0ge09iamVjdH0gY29kZSAtIHRoZSBhdXRob3JpemF0aW9uIGNvZGUgb2JqZWN0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhdXRob3JpemF0aW9uQ29kZSAtIHRoZSBhdXRob3JpemF0aW9uIGNvZGUgc3RyaW5nXG4gICAqIEBwYXJhbSB7RGF0ZX0gY29kZS5leHBpcmVzQXQgLXRoZSB0aW1lIHdoZW4gdGhlIGNvZGUgc2hvdWxkIGV4cGlyZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gY29kZS5yZWRpcmVjdFVyaSAtIHRoZSByZWRpcmVjdCB1cmlcbiAgICogQHBhcmFtIHtTdHJpbmd9IGNvZGUuc2NvcGUgLSB0aGUgYXV0aG9yaXphdGlvbiBzY29wZVxuICAgKiBAcGFyYW0ge09iamVjdH0gY29kZS5jbGllbnQgLSB0aGUgY2xpZW50IG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gY29kZS5jbGllbnQuaWQgLSB0aGUgY2xpZW50IGlkXG4gICAqIEBwYXJhbSB7T2JqZWN0fSAgY29kZS51c2VyIC0gdGhlIHVzZXIgb2JqZWN0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBjb2RlLnVzZXIudXNlcm5hbWUgLSB0aGUgdXNlciBpZGVudGlmaWVyXG4gICAqIEByZXR1cm4ge0Jvb2xlYW59IC0gdHJ1ZSBpZiB0aGUgY29kZSBpcyByZXZva2VkIHN1Y2Nlc3NmdWxseSxmYWxzZSBpZiB0aGUgY291bGQgbm90IGJlIGZvdW5kXG4gICAqL1xuICByZXZva2VBdXRob3JpemF0aW9uQ29kZTogYXN5bmMgY29kZSA9PiB7XG4gICAgY29uc29sZS5sb2coJ3Jldm9rZUF1dGhvcml6YXRpb25Db2RlIGZ1bmN0aW9uJylcblxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBBcHBsaWNhdGlvbi5yZXRoaW5rZGJDb25uZWN0aW9uXG4gICAgbGV0IGZpbHRlck9iamVjdCA9IHsgdG9rZW46IGNvZGUuY29kZSB9XG4gICAgbGV0IHsgZGVsZXRlZDogZGVsZXRpb25SZXN1bHQgfSA9IGF3YWl0IHJldGhpbmtEQlxuICAgICAgLmRiKCd3ZWJhcHBTZXR0aW5nJylcbiAgICAgIC50YWJsZSgnb0F1dGhfdG9rZW4nKVxuICAgICAgLmZpbHRlcihmaWx0ZXJPYmplY3QpXG4gICAgICAuZGVsZXRlKClcbiAgICAgIC5ydW4oY29ubmVjdGlvbilcbiAgICByZXR1cm4gZGVsZXRpb25SZXN1bHQgPyB0cnVlIDogZmFsc2VcbiAgfSxcblxuICAvKipcbiAgICogdGhlIG5vZGUtb2F1dGgyLXNlcnZlciB1c2VzIHRoaXMgbWV0aG9kIHRvIGRldGVybWluZSB3aGF0IHNjb3BlcyBzaG91bGQgYmUgZ3JhbnRlZCB0byB0aGUgY2xpZW50IGZvciBhY2Nlc3NpbmcgdGhlIHVzZXIncyBkYXRhLlxuICAgKiBmb3IgZXhhbXBsZSwgdGhlIGNsaWVudCByZXF1ZXN0cyB0aGUgb2F1dGggc2VydmVyIGZvciBhbiBhY2Nlc3MgdG9rZW4gb2YgdGhlICd1c2VyX2luZm86cmVhZCx1c2VyX2luZm9fd3JpdGUnIHNjb3BlLFxuICAgKiBidXQgdGhlIG9hdXRoIHNlcnZlciBkZXRlcm1pbmUgYnkgdGhpcyBtZXRob2QgdGhhdCBvbmx5IHRoZSAndXNlcl9pbmZvOnJlYWQnIHNjb3BlIHNob3VsZCBiZSBncmFudGVkLlxuICAgKiBAcGFyYW0ge09iamVjdH0gdXNlciAtIHRoZSB1c2VyIHdob3NlIGRhdGEgdGhlIGNsaWVudCB3YW50cyB0byBhY2Nlc3NcbiAgICogQHBhcmFtIHtTdHJpbmd9IHVzZXIudXNlcm5hbWUgLSB0aGUgdXNlciBpZGVudGlmaWVyXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjbGllbnQgLSB0aGUgb2F1dGggY2xpZW50XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBjbGllbnQuaWQgLSB0aGUgY2xpZW50IGlkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzY29wZSAtIHRoZSBzY29wZXMgd2hpY2ggdGhlIGNsaWVudCByZXF1ZXN0ZWQgZm9yXG4gICAqIEByZXR1cm4ge1N0cmluZ30gdmFsaWRTY29wZXMgLSB0aGUgYWN0dWFsIHZhbGlkIHNjb3BlcyBmb3IgdGhlIGNsaWVudCwgbnVsbCBpZiBubyB2YWxpZCBzY29wZXMgZm9yIHRoZSBjbGllbnRcbiAgICovXG4gIHZhbGlkYXRlU2NvcGU6IGFzeW5jICh1c2VyLCBjbGllbnQsIHNjb3BlKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ3ZhbGlkYXRlU2NvcGUgZnVuY3Rpb24nKVxuICAgIGlmICghc2NvcGUpIHJldHVybiBudWxsXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IEFwcGxpY2F0aW9uLnJldGhpbmtkYkNvbm5lY3Rpb25cbiAgICBsZXQgZGJGaWx0ZXJPYmplY3QgPSB7IGtleTogY2xpZW50LmlkIH1cbiAgICBjbGllbnQgPSBhd2FpdCBnZXRUYWJsZURvY3VtZW50Lmluc3RhbmNlWydvQXV0aF9jbGllbnQnXShjb25uZWN0aW9uLCBkYkZpbHRlck9iamVjdClcbiAgICBpZiAoIWNsaWVudCB8fCAhY2xpZW50LnNjb3BlKSByZXR1cm4gbnVsbFxuICAgIGxldCB2YWxpZFNjb3BlcyA9IGNsaWVudC5zY29wZS5zcGxpdCgnLCcpLm1hcChzID0+IHMudHJpbSgpKVxuICAgIGxldCBzY29wZXMgPSBzY29wZVxuICAgICAgLnNwbGl0KCcsJylcbiAgICAgIC5tYXAocyA9PiBzLnRyaW0oKSlcbiAgICAgIC5maWx0ZXIocyA9PiB2YWxpZFNjb3Blcy5pbmRleE9mKHMpID49IDApXG4gICAgcmV0dXJuIHNjb3BlLmxlbmd0aCA/IHNjb3Blcy5qb2luKCcsJykgOiBudWxsXG4gIH0sXG5cbiAgLyoqXG4gICAqIG5vZGUtb2F1dGgyLXNlcnZlciB1c2VzIHRoaXMgbWV0aG9kIGluIGF1dGhlbnRpY2F0aW9uIGhhbmRsZXIgdG8gdmVyaWZ5IHdoZXRoZXIgYW4gYWNjZXNzIHRva2VuIGZyb20gYSByZXF1ZXN0IGlzIHN1ZmZpY2llbnQgdG8gdGhlICdzY29wZScgZGVjbGFyZWQgZm9yIHRoZSByZXF1ZXN0ZWQgcmVzb3VyY2VzXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBhY2Nlc3NUb2tlbiAtIHRoZSBhY2Nlc3NUb2tlbiBvYmplY3RcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY2Vzc1Rva2VuLmFjY2Vzc1Rva2VuIC0gdGhlIGFjY2Vzc1Rva2VuIHN0cmluZ1xuICAgKiBAcGFyYW0ge0RhdGV9IGFjY2Vzc1Rva2VuLmFjY2Vzc1Rva2VuRXhwaXJlc0F0IC0gdGhlIHRpbWUgd2hlbiB0aGUgdG9rZW4gc2hvdWxkIGV4cGlyZVxuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjZXNzVG9rZW4uc2NvcGUgLSB0aGUgZ3JhbnRlZCBhY2Nlc3Mgc2NvcGUgb2YgdGhlIHRva2VuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBhY2Nlc3NUb2tlbi5jbGllbnQgLSB0aGUgY2xpZW50IG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjZXNzVG9rZW4uY2xpZW50LmlkIC0gdGhlIGNsaWVudCBpZFxuICAgKiBAcGFyYW0ge09iamVjdH0gYWNjZXNzVG9rbmUudXNlciAtIHRoZSB1c2VyIG9iamVjdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjZXNzVG9rZW4udXNlci51c2VybmFtZSAtIHRoZSB1c2VyIGlkZW50aWZpZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHNjb3BlIC0gdGhlIHNjb3BlIGRlY2xhcmVkIGZvciB0aGUgcmVzb3VyY2VzXG4gICAqIEByZXR1cm4ge0Jvb2xlYW59IC0gdHJ1ZSBpZiB0aGUgYWNjZXNzIHRva2VuIGhhcyBzdWZmaWNpZW50IGFjY2VzcyBzY29wZXMgZm9yIHRoZSByZXNvdXJjZXNcbiAgICovXG4gIHZlcmlmeVNjb3BlOiBhc3luYyAoYWNjZXNzVG9rZW4sIHNjb3BlKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ3ZlcmlmeVNjb3BlIGZ1bmN0aW9uJylcblxuICAgIC8vbm8gc2NvcGUgZGVjbGFyZWQgZm9yIHRoZSByZXNvdXJjZSwgZnJlZSB0byBhY2Nlc3NcbiAgICBpZiAoIXNjb3BlKSByZXR1cm4gdHJ1ZVxuICAgIGlmICghYWNjZXNzVG9rZW4uc2NvcGUpIHJldHVybiBmYWxzZVxuICAgIHZhbGlkU2NvcGVzID0gc2NvcGUuc3BsaXQoJywnKS5tYXAocyA9PiBzLnRyaW0oKSlcbiAgICBzY29wZXMgPSBhY2Nlc3NUb2tlbi5zY29wZS5zcGxpdCgnLCcpLm1hcChzID0+IHMudHJpbSgpKVxuICAgIC8vY2hlY2sgaWYgYXQgbGVhc3Qgb25lIG9mIHRoZSBzY29wZXMgZ3JhbnRlZCB0byB0aGUgYWNjZXNzIHRva2VuIGFyZSBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgcmVzb3VyY2VcbiAgICByZXR1cm4gc2NvcGVzLnNvbWUocyA9PiB2YWxpZFNjb3Blcy5pbmRleE9mKHMpID49IDApXG4gIH0sXG59XG4iXX0=